import{_ as i,c as a,o as n,aA as l}from"./chunks/framework.WUNZxBbc.js";const E=JSON.parse('{"title":"Internals: RBF Weight Building System","description":"","frontmatter":{},"headers":[],"relativePath":"internals.md","filePath":"internals.md","lastUpdated":null}'),t={name:"internals.md"};function p(e,s,h,k,r,d){return n(),a("div",null,[...s[0]||(s[0]=[l(`<h1 id="Internals:-RBF-Weight-Building-System" tabindex="-1">Internals: RBF Weight Building System <a class="header-anchor" href="#Internals:-RBF-Weight-Building-System" aria-label="Permalink to &quot;Internals: RBF Weight Building System {#Internals:-RBF-Weight-Building-System}&quot;">​</a></h1><p>This document explains the code flow in the solve system, which builds sparse weight matrices for RBF operators.</p><h2 id="Architecture-Overview" tabindex="-1">Architecture Overview <a class="header-anchor" href="#Architecture-Overview" aria-label="Permalink to &quot;Architecture Overview {#Architecture-Overview}&quot;">​</a></h2><p>The solve system is organized into <strong>three distinct layers</strong>:</p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>src/solve/</span></span>
<span class="line"><span>├── types.jl          # Layer 0: Shared data structures &amp; traits</span></span>
<span class="line"><span>├── stencil_math.jl   # Layer 1: Pure mathematical operations</span></span>
<span class="line"><span>├── kernel_exec.jl    # Layer 2: Parallel execution &amp; allocation</span></span>
<span class="line"><span>└── api.jl            # Layer 3: Entry points &amp; routing</span></span></code></pre></div><h3 id="Layer-Responsibilities" tabindex="-1">Layer Responsibilities <a class="header-anchor" href="#Layer-Responsibilities" aria-label="Permalink to &quot;Layer Responsibilities {#Layer-Responsibilities}&quot;">​</a></h3><p><strong>Layer 0: <code>types.jl</code></strong> - Shared Data Structures</p><ul><li><p>Boundary condition types (<code>BoundaryCondition</code>, <code>HermiteStencilData</code>)</p></li><li><p>Stencil classification types (<code>InteriorStencil</code>, <code>DirichletStencil</code>, <code>HermiteStencil</code>)</p></li><li><p>Operator arity traits (<code>SingleOperator</code>, <code>MultiOperator{N}</code>)</p></li></ul><p><strong>Layer 1: <code>stencil_math.jl</code></strong> - Pure Mathematics</p><ul><li><p>Collocation matrix building (<code>_build_collocation_matrix!</code>)</p></li><li><p>RHS vector building (<code>_build_rhs!</code>)</p></li><li><p>Stencil assembly (<code>_build_stencil!</code>)</p></li><li><p>Hermite boundary modifications (dispatch-based)</p></li><li><p><strong>No I/O, no parallelism, fully testable</strong></p></li></ul><p><strong>Layer 2: <code>kernel_exec.jl</code></strong> - Parallel Execution</p><ul><li><p>Memory allocation (<code>allocate_sparse_arrays</code>)</p></li><li><p>Kernel launching (<code>launch_kernel!</code>)</p></li><li><p>Batch processing and synchronization</p></li><li><p>Sparse matrix construction</p></li></ul><p><strong>Layer 3: <code>api.jl</code></strong> - Entry Points</p><ul><li><p>Public <code>_build_weights</code> functions</p></li><li><p>Routing (standard vs Hermite paths)</p></li><li><p>Operator application to basis functions</p></li></ul><hr><h2 id="System-Flow" tabindex="-1">System Flow <a class="header-anchor" href="#System-Flow" aria-label="Permalink to &quot;System Flow {#System-Flow}&quot;">​</a></h2><p>The system builds sparse weight matrices using exact allocation:</p><ul><li><p>Interior points get k entries (full stencil)</p></li><li><p>Dirichlet boundary points get 1 entry (identity row)</p></li><li><p>Other boundary points get k entries (Hermite stencil)</p></li></ul><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>User Code</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>api.jl: Route based on boundary conditions</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>kernel_exec.jl: Allocate memory &amp; launch parallel kernel</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>stencil_math.jl: Build collocation matrix A, RHS b, solve A\\b</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>kernel_exec.jl: Construct sparse matrix</span></span>
<span class="line"><span>    ↓</span></span>
<span class="line"><span>Return to user</span></span></code></pre></div><hr><h2 id="Part-1:-Entry-Points-api.jl" tabindex="-1">Part 1: Entry Points (api.jl) <a class="header-anchor" href="#Part-1:-Entry-Points-api.jl" aria-label="Permalink to &quot;Part 1: Entry Points (api.jl) {#Part-1:-Entry-Points-api.jl}&quot;">​</a></h2><h3 id="Main-Entry-from-Operators" tabindex="-1">Main Entry from Operators <a class="header-anchor" href="#Main-Entry-from-Operators" aria-label="Permalink to &quot;Main Entry from Operators {#Main-Entry-from-Operators}&quot;">​</a></h3><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _build_weights</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ℒ, op)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Extract configuration from operator</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> op</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    eval_points </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> op</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">eval_points</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    adjl </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> op</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">adjl</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    basis </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> op</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">basis</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> _build_weights</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ℒ, data, eval_points, adjl, basis)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="Apply-Operator-to-Basis" tabindex="-1">Apply Operator to Basis <a class="header-anchor" href="#Apply-Operator-to-Basis" aria-label="Permalink to &quot;Apply Operator to Basis {#Apply-Operator-to-Basis}&quot;">​</a></h3><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _build_weights</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ℒ, data, eval_points, adjl, basis)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    dim </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">first</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data))</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Build monomial basis and apply operator</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    mon </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> MonomialBasis</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(dim, basis</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">poly_deg)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ℒmon </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ℒ</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(mon)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    ℒrbf </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ℒ</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(basis)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> _build_weights</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data, eval_points, adjl, basis, ℒrbf, ℒmon, mon)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="Interior-Only-Path-No-Boundary-Conditions" tabindex="-1">Interior-Only Path (No Boundary Conditions) <a class="header-anchor" href="#Interior-Only-Path-No-Boundary-Conditions" aria-label="Permalink to &quot;Interior-Only Path (No Boundary Conditions) {#Interior-Only-Path-No-Boundary-Conditions}&quot;">​</a></h3><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _build_weights</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    data, eval_points, adjl, basis, ℒrbf, ℒmon, mon;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    batch_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, device</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CPU</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Create empty boundary data for interior-only case</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    TD </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> eltype</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">first</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    is_boundary </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> fill</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">false</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    boundary_conditions </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BoundaryCondition{TD}[]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    normals </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> similar</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">0</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    boundary_data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> BoundaryData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(is_boundary, boundary_conditions, normals)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> build_weights_kernel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        data, eval_points, adjl,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        basis, ℒrbf, ℒmon, mon,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        boundary_data;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        batch_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">batch_size, device</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">device</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    )</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="Hermite-Path-With-Boundary-Conditions" tabindex="-1">Hermite Path (With Boundary Conditions) <a class="header-anchor" href="#Hermite-Path-With-Boundary-Conditions" aria-label="Permalink to &quot;Hermite Path (With Boundary Conditions) {#Hermite-Path-With-Boundary-Conditions}&quot;">​</a></h3><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _build_weights</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    data, eval_points, adjl, basis, ℒrbf, ℒmon, mon,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    is_boundary, boundary_conditions, normals;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    batch_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, device</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CPU</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    boundary_data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> BoundaryData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(is_boundary, boundary_conditions, normals)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> build_weights_kernel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        data, eval_points, adjl,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        basis, ℒrbf, ℒmon, mon,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        boundary_data;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        batch_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">batch_size, device</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">device</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    )</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><hr><h2 id="Part-2:-Kernel-Orchestration-kernel_exec.jl" tabindex="-1">Part 2: Kernel Orchestration (kernel_exec.jl) <a class="header-anchor" href="#Part-2:-Kernel-Orchestration-kernel_exec.jl" aria-label="Permalink to &quot;Part 2: Kernel Orchestration (kernel_exec.jl) {#Part-2:-Kernel-Orchestration-kernel_exec.jl}&quot;">​</a></h2><h3 id="Main-Orchestrator" tabindex="-1">Main Orchestrator <a class="header-anchor" href="#Main-Orchestrator" aria-label="Permalink to &quot;Main Orchestrator {#Main-Orchestrator}&quot;">​</a></h3><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> build_weights_kernel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    data, eval_points, adjl, basis, ℒrbf, ℒmon, mon,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    boundary_data; batch_size</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">10</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, device</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">CPU</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Extract dimensions</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    TD </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> eltype</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">first</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    k </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">first</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(adjl))</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    nmon </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> binomial</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">first</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data)) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> basis</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">poly_deg, basis</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">poly_deg)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    num_ops </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> _num_ops</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ℒrbf)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    N_eval </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(eval_points)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Allocate sparse arrays with exact counting</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    I, J, V, row_offsets </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> allocate_sparse_arrays</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        TD, k, N_eval, num_ops, adjl, boundary_data</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    )</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Launch parallel kernel</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    n_batches </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ceil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Int, N_eval </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">/</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> batch_size)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    launch_kernel!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        I, J, V, data, eval_points, adjl,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        basis, ℒrbf, ℒmon, mon, boundary_data, row_offsets,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        batch_size, N_eval, n_batches, k, nmon, num_ops, device</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    )</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Construct sparse matrix</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    nrows, ncols </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> N_eval, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">length</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> num_ops </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> sparse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(I, J, V[:, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">], nrows, ncols)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    else</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> ntuple</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> sparse</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(I, J, V[:, i], nrows, ncols), num_ops)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="Memory-Allocation" tabindex="-1">Memory Allocation <a class="header-anchor" href="#Memory-Allocation" aria-label="Permalink to &quot;Memory Allocation {#Memory-Allocation}&quot;">​</a></h3><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> allocate_sparse_arrays</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(TD, k, N_eval, num_ops, adjl, boundary_data)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Count exact non-zeros:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # - Interior points: k entries (full stencil)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # - Dirichlet points: 1 entry (identity row)</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # - Other boundary points: k entries (Hermite stencil)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    total_nnz, row_offsets </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> count_nonzeros</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        adjl, boundary_data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">is_boundary, boundary_data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">boundary_conditions</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    )</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    I </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Vector{Int}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(undef, total_nnz)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    J </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Vector{Int}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(undef, total_nnz)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    V </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Matrix{TD}</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(undef, total_nnz, num_ops)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> I, J, V, row_offsets</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="Kernel-Execution" tabindex="-1">Kernel Execution <a class="header-anchor" href="#Kernel-Execution" aria-label="Permalink to &quot;Kernel Execution {#Kernel-Execution}&quot;">​</a></h3><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">@kernel</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> weight_kernel</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(I, J, V, data, eval_points, adjl, boundary_data, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    batch_idx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> @index</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(Global)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    start_idx, end_idx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> calculate_batch_range</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(batch_idx, batch_size, N_eval)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Pre-allocate work arrays (reused within batch)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    A </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> Symmetric</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">zeros</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(TD, n, n), </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">:U</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    b </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> _prepare_buffer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ℒrbf, TD, n)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> eval_idx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> start_idx</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">end_idx</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">        # Classify stencil type based on boundary conditions</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        stype </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> classify_stencil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            boundary_data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">is_boundary, boundary_data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">boundary_conditions,</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            eval_idx, neighbors, global_to_boundary</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        )</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> stype </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">isa</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DirichletStencil</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            # Identity row: only diagonal is 1.0</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            fill_dirichlet_entry!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(I, J, V, eval_idx, start_pos, num_ops)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        elseif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> stype </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">isa</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> InteriorStencil</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            # Standard interior stencil (no boundary points)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            local_data </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> view</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data, neighbors)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            weights </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> _build_stencil!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(A, b, ℒrbf, ℒmon, local_data, eval_point, basis, mon, k)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            fill_entries!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(I, J, V, weights, eval_idx, neighbors, start_pos, k, num_ops)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        else</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # HermiteStencil</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">            # Mixed interior/boundary stencil</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            update_hermite_stencil_data!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(hermite_data, data, neighbors, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            weights </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> _build_stencil!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(A, b, ℒrbf, ℒmon, hermite_data, eval_point, basis, mon, k)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            fill_entries!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(I, J, V, weights, eval_idx, neighbors, start_pos, k, num_ops)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p>Stencil classification via dispatch:</p><ul><li><p><strong>DirichletStencil</strong>: Identity row (only diagonal)</p></li><li><p><strong>InteriorStencil</strong>: Standard stencil (all neighbors are interior)</p></li><li><p><strong>HermiteStencil</strong>: Mixed interior/boundary stencil</p></li></ul><hr><h2 id="Part-3:-Stencil-Mathematics-stencil_math.jl" tabindex="-1">Part 3: Stencil Mathematics (stencil_math.jl) <a class="header-anchor" href="#Part-3:-Stencil-Mathematics-stencil_math.jl" aria-label="Permalink to &quot;Part 3: Stencil Mathematics (stencil_math.jl) {#Part-3:-Stencil-Mathematics-stencil_math.jl}&quot;">​</a></h2><h3 id="Stencil-Assembly" tabindex="-1">Stencil Assembly <a class="header-anchor" href="#Stencil-Assembly" aria-label="Permalink to &quot;Stencil Assembly {#Stencil-Assembly}&quot;">​</a></h3><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _build_stencil!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(A, b, ℒrbf, ℒmon, data, eval_point, basis, mon, k)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    _build_collocation_matrix!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(A, data, basis, mon, k)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    _build_rhs!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(b, ℒrbf, ℒmon, data, eval_point, basis, k)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (A </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">\\</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> b)[</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">k, :]</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p><strong>Key insight</strong>: Multiple dispatch on <code>data</code> type automatically selects:</p><ul><li><p><code>data::AbstractVector</code> → Standard interior stencil</p></li><li><p><code>data::HermiteStencilData</code> → Hermite boundary stencil</p></li></ul><h3 id="Collocation-Matrix-Building" tabindex="-1">Collocation Matrix Building <a class="header-anchor" href="#Collocation-Matrix-Building" aria-label="Permalink to &quot;Collocation Matrix Building {#Collocation-Matrix-Building}&quot;">​</a></h3><p><strong>Standard (Interior)</strong>:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _build_collocation_matrix!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(A, data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">AbstractVector</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, basis, mon, k)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    AA </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> parent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(A)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    N </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(A, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # RBF block (upper triangular)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> j </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">k, i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">j</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        AA[i, j] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> basis</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data[i], data[j])  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Φ(xᵢ, xⱼ)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Polynomial augmentation block</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> basis</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">poly_deg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">k</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> view</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(AA, i, (k </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">N)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            mon</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(a, data[i])  </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># P(xᵢ)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p><strong>Hermite (With Boundary Conditions)</strong>:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> _build_collocation_matrix!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(A, data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">HermiteStencilData</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, basis, mon, k)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    AA </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> parent</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(A)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    N </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> size</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(A, </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">2</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # RBF block with Hermite modifications</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> j </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">k, i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">j</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        AA[i, j] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> compute_hermite_rbf_entry</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(i, j, data, basis)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Polynomial block with boundary modifications</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> basis</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">poly_deg </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&gt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> -</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">1</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        for</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">in</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">k</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            a </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> view</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(AA, i, (k </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 1</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">N)</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">            compute_hermite_poly_entry!</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(a, i, data, mon)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="Hermite-RBF-Entry-Dispatch" tabindex="-1">Hermite RBF Entry Dispatch <a class="header-anchor" href="#Hermite-RBF-Entry-Dispatch" aria-label="Permalink to &quot;Hermite RBF Entry Dispatch {#Hermite-RBF-Entry-Dispatch}&quot;">​</a></h3><p>Uses <strong>9 dispatch methods</strong> based on point types (Interior/Dirichlet/NeumannRobin):</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> compute_hermite_rbf_entry</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(i, j, data, basis)</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    xi, xj </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data[i], data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">data[j]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    type_i </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> point_type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">is_boundary[i], data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">boundary_conditions[i])</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    type_j </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> point_type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">is_boundary[j], data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">.</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">boundary_conditions[j])</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> hermite_rbf_dispatch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(type_i, type_j, i, j, xi, xj, data, basis)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><p><strong>Example dispatches</strong>:</p><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Interior-Interior: Standard evaluation</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">hermite_rbf_dispatch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">InteriorPoint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">InteriorPoint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> basis</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(xi, xj)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Interior-NeumannRobin: Apply boundary operator to second argument</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">hermite_rbf_dispatch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">InteriorPoint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NeumannRobinPoint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    α</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bc_j) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> φ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> β</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bc_j) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> dot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(nj, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">∇φ)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># NeumannRobin-NeumannRobin: Apply to both arguments</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">hermite_rbf_dispatch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NeumannRobinPoint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">NeumannRobinPoint</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    α</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bc_i) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> α</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bc_j) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> φ </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    α</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bc_i) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> β</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bc_j) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> dot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(nj, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">∇φ) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    β</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bc_i) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> α</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bc_j) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> dot</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ni, ∇φ) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">+</span></span>
<span class="line"><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">    β</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bc_i) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> β</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(bc_j) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">*</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> ∂i∂j_φ</span></span></code></pre></div><h3 id="RHS-Vector-Building" tabindex="-1">RHS Vector Building <a class="header-anchor" href="#RHS-Vector-Building" aria-label="Permalink to &quot;RHS Vector Building {#RHS-Vector-Building}&quot;">​</a></h3><p>Similar dispatch pattern:</p><ul><li><p><code>_build_rhs!(b::Vector, ℒrbf, ...)</code> → Single operator</p></li><li><p><code>_build_rhs!(b::Matrix, ℒrbf::Tuple, ...)</code> → Multiple operators</p></li><li><p><code>_build_rhs!(b, ..., data::AbstractVector, ...)</code> → Interior</p></li><li><p><code>_build_rhs!(b, ..., data::HermiteStencilData, ...)</code> → Hermite</p></li></ul><hr><h2 id="Part-4:-Data-Structures-types.jl" tabindex="-1">Part 4: Data Structures (types.jl) <a class="header-anchor" href="#Part-4:-Data-Structures-types.jl" aria-label="Permalink to &quot;Part 4: Data Structures (types.jl) {#Part-4:-Data-Structures-types.jl}&quot;">​</a></h2><h3 id="Boundary-Condition" tabindex="-1">Boundary Condition <a class="header-anchor" href="#Boundary-Condition" aria-label="Permalink to &quot;Boundary Condition {#Boundary-Condition}&quot;">​</a></h3><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> BoundaryCondition{T</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Real</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    α</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">T</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Coefficient for value</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    β</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">T</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Coefficient for normal derivative</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Boundary operator: Bu = α*u + β*∂ₙu</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># Special cases:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   Dirichlet: α=1, β=0</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   Neumann:   α=0, β=1</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">#   Robin:     α≠0, β≠0</span></span></code></pre></div><h3 id="Hermite-Stencil-Data" tabindex="-1">Hermite Stencil Data <a class="header-anchor" href="#Hermite-Stencil-Data" aria-label="Permalink to &quot;Hermite Stencil Data {#Hermite-Stencil-Data}&quot;">​</a></h3><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> HermiteStencilData{T</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Real</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    data</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">AbstractVector{Vector{T}}</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">              # k stencil points</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    is_boundary</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Vector{Bool}</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                    # k flags</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    boundary_conditions</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Vector{BoundaryCondition{T}}</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # k conditions</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    normals</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">::</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">Vector{Vector{T}}</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">                   # k normal vectors</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><h3 id="Stencil-Classification" tabindex="-1">Stencil Classification <a class="header-anchor" href="#Stencil-Classification" aria-label="Permalink to &quot;Stencil Classification {#Stencil-Classification}&quot;">​</a></h3><div class="language-julia vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">julia</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">abstract type</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> StencilType </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> InteriorStencil </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> StencilType</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> end</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">   # All neighbors interior</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> DirichletStencil </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> StencilType</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> end</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Eval point is Dirichlet</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">struct</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> HermiteStencil </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&lt;:</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> StencilType</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> end</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">    # Mixed interior/boundary</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">function</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> classify_stencil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(is_boundary, boundary_conditions, eval_idx, neighbors, </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    if</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> sum</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(is_boundary[neighbors]) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">==</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> 0</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> InteriorStencil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    elseif</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> is_boundary[eval_idx] </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">&amp;&amp;</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> is_dirichlet</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(boundary_conditions[</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">...</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">])</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> DirichletStencil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    else</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> HermiteStencil</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    end</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">end</span></span></code></pre></div><hr><h2 id="Call-Graph" tabindex="-1">Call Graph <a class="header-anchor" href="#Call-Graph" aria-label="Permalink to &quot;Call Graph {#Call-Graph}&quot;">​</a></h2><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>User Code (e.g., Laplacian construction)</span></span>
<span class="line"><span>    │</span></span>
<span class="line"><span>    └─→ api.jl: _build_weights(ℒ, op)</span></span>
<span class="line"><span>            │</span></span>
<span class="line"><span>            ├─→ Apply operator to basis: ℒrbf = ℒ(basis), ℒmon = ℒ(mon)</span></span>
<span class="line"><span>            │</span></span>
<span class="line"><span>            └─→ Route based on boundary conditions</span></span>
<span class="line"><span>                    │</span></span>
<span class="line"><span>                    └─→ kernel_exec.jl: build_weights_kernel(...)</span></span>
<span class="line"><span>                            │</span></span>
<span class="line"><span>                            ├─→ allocate_sparse_arrays(...)</span></span>
<span class="line"><span>                            │       └─→ count_nonzeros → Exact allocation</span></span>
<span class="line"><span>                            │</span></span>
<span class="line"><span>                            ├─→ launch_kernel!(...)</span></span>
<span class="line"><span>                            │       │</span></span>
<span class="line"><span>                            │       └─→ @kernel weight_kernel</span></span>
<span class="line"><span>                            │               │</span></span>
<span class="line"><span>                            │               └─→ FOR each eval_point in batch:</span></span>
<span class="line"><span>                            │                       │</span></span>
<span class="line"><span>                            │                       ├─→ types.jl: classify_stencil(...)</span></span>
<span class="line"><span>                            │                       │       └─→ {Dirichlet, Interior, Hermite}</span></span>
<span class="line"><span>                            │                       │</span></span>
<span class="line"><span>                            │                       ├─→ IF DirichletStencil:</span></span>
<span class="line"><span>                            │                       │       └─→ Fill identity row</span></span>
<span class="line"><span>                            │                       │</span></span>
<span class="line"><span>                            │                       ├─→ IF InteriorStencil:</span></span>
<span class="line"><span>                            │                       │       └─→ stencil_math.jl: _build_stencil!</span></span>
<span class="line"><span>                            │                       │               (standard interior)</span></span>
<span class="line"><span>                            │                       │</span></span>
<span class="line"><span>                            │                       └─→ IF HermiteStencil:</span></span>
<span class="line"><span>                            │                               │</span></span>
<span class="line"><span>                            │                               ├─→ types.jl: update_hermite_stencil_data!</span></span>
<span class="line"><span>                            │                               │</span></span>
<span class="line"><span>                            │                               └─→ stencil_math.jl: _build_stencil!</span></span>
<span class="line"><span>                            │                                       ├─→ _build_collocation_matrix!</span></span>
<span class="line"><span>                            │                                       │       └─→ compute_hermite_rbf_entry</span></span>
<span class="line"><span>                            │                                       │               └─→ hermite_rbf_dispatch</span></span>
<span class="line"><span>                            │                                       │                       (9 point type combos)</span></span>
<span class="line"><span>                            │                                       │</span></span>
<span class="line"><span>                            │                                       ├─→ _build_rhs!</span></span>
<span class="line"><span>                            │                                       │       ├─→ hermite_rbf_rhs</span></span>
<span class="line"><span>                            │                                       │       └─→ hermite_mono_rhs!</span></span>
<span class="line"><span>                            │                                       │</span></span>
<span class="line"><span>                            │                                       └─→ solve(A, b)</span></span>
<span class="line"><span>                            │</span></span>
<span class="line"><span>                            └─→ sparse(I, J, V) → Return</span></span></code></pre></div><hr><h2 id="Key-Concepts" tabindex="-1">Key Concepts <a class="header-anchor" href="#Key-Concepts" aria-label="Permalink to &quot;Key Concepts {#Key-Concepts}&quot;">​</a></h2><h3 id="1.-Layer-Separation" tabindex="-1">1. Layer Separation <a class="header-anchor" href="#1.-Layer-Separation" aria-label="Permalink to &quot;1. Layer Separation {#1.-Layer-Separation}&quot;">​</a></h3><p><strong>Why it matters</strong>:</p><ul><li><p><strong>stencil_math.jl</strong> contains pure functions → easily testable</p></li><li><p><strong>kernel_exec.jl</strong> handles parallelism → can benchmark separately</p></li><li><p><strong>api.jl</strong> routes requests → single place to trace flow</p></li></ul><h3 id="2.-Stencil" tabindex="-1">2. Stencil <a class="header-anchor" href="#2.-Stencil" aria-label="Permalink to &quot;2. Stencil {#2.-Stencil}&quot;">​</a></h3><p>A <strong>stencil</strong> is a local approximation of a differential operator at a point:</p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>For a point x₀ with k neighbors {x₁, x₂, ..., xₖ}:</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    ℒu(x₀) ≈ Σᵢ₌₁ᵏ wᵢ * u(xᵢ)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>where wᵢ are the weights we compute by solving A \\ b.</span></span></code></pre></div><h3 id="3.-Collocation-Matrix-Structure" tabindex="-1">3. Collocation Matrix Structure <a class="header-anchor" href="#3.-Collocation-Matrix-Structure" aria-label="Permalink to &quot;3. Collocation Matrix Structure {#3.-Collocation-Matrix-Structure}&quot;">​</a></h3><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>Standard (Interior):</span></span>
<span class="line"><span>┌─────────────────┬─────────┐</span></span>
<span class="line"><span>│  Φ(xᵢ, xⱼ)      │ P(xᵢ)   │  k×k RBF + k×nmon polynomial</span></span>
<span class="line"><span>├─────────────────┼─────────┤</span></span>
<span class="line"><span>│  P(xⱼ)ᵀ         │   0     │  nmon×k poly + nmon×nmon zero</span></span>
<span class="line"><span>└─────────────────┴─────────┘</span></span>
<span class="line"><span></span></span>
<span class="line"><span>Hermite (with Boundary):</span></span>
<span class="line"><span>Same structure, but entries modified by boundary operators:</span></span>
<span class="line"><span>- Interior-Interior: Φ(xᵢ, xⱼ)</span></span>
<span class="line"><span>- Interior-Boundary: BⱼΦ(xᵢ, xⱼ)</span></span>
<span class="line"><span>- Boundary-Boundary: BᵢBⱼΦ(xᵢ, xⱼ)</span></span>
<span class="line"><span></span></span>
<span class="line"><span>where Bᵢ = α*I + β*∂ₙᵢ is the boundary operator at point i</span></span></code></pre></div><h3 id="4.-Multiple-Dispatch-Benefits" tabindex="-1">4. Multiple Dispatch Benefits <a class="header-anchor" href="#4.-Multiple-Dispatch-Benefits" aria-label="Permalink to &quot;4. Multiple Dispatch Benefits {#4.-Multiple-Dispatch-Benefits}&quot;">​</a></h3><p>The code uses Julia&#39;s multiple dispatch to automatically select:</p><ul><li><p>Vector vs Matrix RHS (single vs tuple operators)</p></li><li><p>AbstractVector vs HermiteStencilData (interior vs boundary)</p></li><li><p>Point type combinations (9 Hermite dispatch variants)</p></li></ul><p>This eliminates explicit conditionals and improves type stability.</p><hr><h2 id="Performance-Characteristics" tabindex="-1">Performance Characteristics <a class="header-anchor" href="#Performance-Characteristics" aria-label="Permalink to &quot;Performance Characteristics {#Performance-Characteristics}&quot;">​</a></h2><h3 id="Memory-Allocation-2" tabindex="-1">Memory Allocation <a class="header-anchor" href="#Memory-Allocation-2" aria-label="Permalink to &quot;Memory Allocation {#Memory-Allocation-2}&quot;">​</a></h3><ul><li><p>Exact allocation via <code>count_nonzeros</code> (counts entries before allocating)</p></li><li><p>Interior points: k entries per stencil</p></li><li><p>Dirichlet points: 1 entry per stencil (identity row)</p></li><li><p>Other boundary points: k entries per stencil</p></li><li><p>No over-allocation for interior-only problems</p></li></ul><h3 id="Parallelization" tabindex="-1">Parallelization <a class="header-anchor" href="#Parallelization" aria-label="Permalink to &quot;Parallelization {#Parallelization}&quot;">​</a></h3><ul><li><p>Batch processing prevents memory exhaustion</p></li><li><p>Work arrays reused within batch</p></li><li><p>KernelAbstractions.jl enables CPU/GPU execution</p></li><li><p>Type-stable buffers via operator arity traits</p></li></ul><h3 id="Stencil-Classification-2" tabindex="-1">Stencil Classification <a class="header-anchor" href="#Stencil-Classification-2" aria-label="Permalink to &quot;Stencil Classification {#Stencil-Classification-2}&quot;">​</a></h3><ul><li><p>Runtime dispatch via <code>classify_stencil</code></p></li><li><p>Zero overhead for interior-only problems (all stencils classify as InteriorStencil)</p></li><li><p>Dirichlet points bypass expensive matrix assembly</p></li></ul><hr><h2 id="Summary" tabindex="-1">Summary <a class="header-anchor" href="#Summary" aria-label="Permalink to &quot;Summary {#Summary}&quot;">​</a></h2><p>The unified solve system achieves:</p><ol><li><p><strong>Clear organization</strong>: 3 layers with distinct responsibilities</p></li><li><p><strong>Single code path</strong>: One allocation strategy, one kernel for all cases</p></li><li><p><strong>Better testability</strong>: Pure math layer has no side effects</p></li><li><p><strong>Easy navigation</strong>: &quot;Where&#39;s X?&quot; → Obvious file location</p></li><li><p><strong>Zero overhead</strong>: Multiple dispatch is compile-time optimization</p></li><li><p><strong>Exact allocation</strong>: No over-allocation for any problem type</p></li><li><p><strong>Backward compatible</strong>: All exports maintained</p></li></ol><p><strong>File Mapping</strong>:</p><ul><li><p>Want to modify math? → <code>stencil_math.jl</code></p></li><li><p>Need better parallelism? → <code>kernel_exec.jl</code></p></li><li><p>Adding new operator entry point? → <code>api.jl</code></p></li><li><p>New boundary condition type? → <code>types.jl</code></p></li></ul>`,97)])])}const c=i(t,[["render",p]]);export{E as __pageData,c as default};
